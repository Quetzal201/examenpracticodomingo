<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#1a1a1a" />
  <meta name="description" content="AplicaciÃ³n Web Progresiva para gestiÃ³n de pedidos" />
  <title>Gestor de Pedidos - PWA</title>
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="/manifest.json" />
  <link rel="apple-touch-icon" href="/img/product-icon.svg" />
  <link rel="icon" type="image/svg+xml" href="/img/product-icon.svg" />
  
  <!-- CSS -->
  <link rel="stylesheet" href="/css/styles.css" />
</head>
<body>
  <div id="app"></div>

  <!-- SPLASH SCREEN (se oculta automÃ¡ticamente al cargar) -->
  <div id="splash" class="splash-overlay">
    <img src="/img/product-splash.svg" alt="Logo" class="splash-logo" />
    <div class="splash-title">Cargando Gestor de Productos...</div>
  </div>

  <!-- NotificaciÃ³n de estado (offline/online) -->
  <div id="toast" class="toast"></div>

  <!-- Modal CRUD -->
  <div id="modalBackdrop" class="modal-backdrop hidden">
    <div class="modal">
      <div class="modal-header">
        <h2 id="modalTitle">Modal</h2>
        <button class="modal-close" onclick="closeModal()">&times;</button>
      </div>
      <div class="modal-body" id="modalBody"></div>
      <div class="modal-footer">
        <button class="btn btn-outline-secondary" onclick="closeModal()">Cancelar</button>
        <button class="btn btn-outline-primary" id="modalActionBtn" onclick="handleModalAction()">Confirmar</button>
      </div>
    </div>
  </div>

  <!-- Scripts en orden correcto -->
  <script>
    // Funciones globales de utilidad
    function showToast(message, type = 'info', duration = 3000) {
      const toast = document.getElementById('toast');
      let icon = 'ðŸ“±';
      let className = type;

      if (type === 'offline') {
        icon = 'ðŸ”´';
      } else if (type === 'online') {
        icon = 'ðŸŸ¢';
      } else if (type === 'success') {
        icon = 'âœ“';
      } else if (type === 'error') {
        icon = 'âœ—';
      } else if (type === 'warning') {
        icon = 'âš ';
      }

      toast.innerHTML = `
        <span class="toast-icon">${icon}</span>
        <span class="toast-message">${message}</span>
      `;
      toast.className = `toast show ${className}`;

      if (duration > 0) {
        setTimeout(() => {
          toast.classList.remove('show');
        }, duration);
      }
    }

    function showModal(title, content, actionText = 'Confirmar', onAction = null) {
      const backdrop = document.getElementById('modalBackdrop');
      const modalTitle = document.getElementById('modalTitle');
      const modalBody = document.getElementById('modalBody');
      const actionBtn = document.getElementById('modalActionBtn');

      modalTitle.textContent = title;
      modalBody.innerHTML = content;
      actionBtn.textContent = actionText;

      window.modalActionCallback = onAction;

      backdrop.classList.remove('hidden');
    }

    function closeModal() {
      const backdrop = document.getElementById('modalBackdrop');
      backdrop.classList.add('hidden');
      window.modalActionCallback = null;
    }

    function handleModalAction() {
      if (window.modalActionCallback) {
        window.modalActionCallback();
      }
    }

    function formatCurrency(value) {
      return new Intl.NumberFormat('es-ES', {
        style: 'currency',
        currency: 'MXN',
      }).format(value);
    }

    function formatDate(dateString) {
      return new Date(dateString).toLocaleDateString('es-ES', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
      });
    }

    // Hacer funciones disponibles globalmente
    window.showToast = showToast;
    window.showModal = showModal;
    window.closeModal = closeModal;
    window.handleModalAction = handleModalAction;
    window.formatCurrency = formatCurrency;
    window.formatDate = formatDate;

    // Mostrar un toast con botÃ³n accionable (texto y callback)
    function showActionToast(message, buttonText = 'OK', onClick = null, duration = 0) {
      const toast = document.getElementById('toast');
      // install icon SVG (inline small)
      const installIcon = `
        <svg class="install-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <path fill="currentColor" d="M5 20h14v-2H5v2zm7-18L5.33 9h3.34v4h6.66V9h3.34L12 2z" />
        </svg>
      `;

      toast.innerHTML = `
        <span class="toast-icon">ðŸ“±</span>
        <span class="toast-message">${message}</span>
        <button id="toastActionBtn" class="toast-action">${installIcon}<span>${buttonText}</span></button>
      `;
      toast.className = `toast show action`;

      const btn = document.getElementById('toastActionBtn');
      if (btn && typeof onClick === 'function') {
        btn.addEventListener('click', () => {
          onClick();
          toast.classList.remove('show');
        });
      }

      if (duration > 0) {
        setTimeout(() => toast.classList.remove('show'), duration);
      }
    }
    window.showActionToast = showActionToast;

    // Mostrar el splash solo si la app fue instalada recientemente (flag set por `appinstalled`)
    (function () {
      try {
        const s = document.getElementById('splash');
        const shouldShow = (function () {
          try { return localStorage.getItem('showSplashOnInstall') === '1'; } catch (e) { return false; }
        })();

        if (!s) return;

        if (!shouldShow) {
          // No queremos mostrar el splash: eliminar inmediatamente
          if (s.parentNode) s.parentNode.removeChild(s);
          return;
        }

        // Si sÃ­ debemos mostrarlo, esperar 3s y ocultarlo; luego limpiar la flag
        let splashRequested = false;
        function hideSplash(delayMs = 3000) {
          try {
            if (splashRequested) return;
            splashRequested = true;
            setTimeout(() => {
              s.classList.add('splash-hide');
              setTimeout(() => { if (s && s.parentNode) s.parentNode.removeChild(s); }, 420);
              try { localStorage.removeItem('showSplashOnInstall'); } catch (e) {}
            }, delayMs);
          } catch (e) { /* ignore */ }
        }

        window.addEventListener('load', () => hideSplash(3000));
        const appReadyInterval = setInterval(() => {
          if (window.app) { hideSplash(3000); clearInterval(appReadyInterval); }
        }, 200);
      } catch (e) { /* ignore */ }
    })();
  </script>
  
  <script src="/js/utils.js"></script>
  <script src="/js/idb.js"></script>
  <script src="/js/offline-manager.js"></script>
  <script src="/js/api.js"></script>
  <script src="/js/auth.js"></script>
  <script src="/js/ui.js"></script>
  <script src="/js/pwa-install.js"></script>
  <script src="/js/app.js"></script>
  
  <!-- Service Worker -->
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js').then(reg => {
        console.log('âœ“ Service Worker registrado');
      }).catch(err => {
        console.error('âœ— Error registrando Service Worker:', err);
      });
    }
  </script>
</body>
</html>
